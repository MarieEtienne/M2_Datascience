---
title: Analyse de la variance
subtitle: à 1 facteur
author: Marie-Pierre Etienne
date: '2020/09/11 (updated: `r Sys.Date()`)'
institute: https://github.com/marieetienne
csl: ../resources/apa-no-doi-no-issue.csl
output:
  xaringan::moon_reader:
    css: [  'metropolis',  'mpe_pres.css']
    lib_dir: libs
    nature:
      ratio: 16:10
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: '../resources/collapseoutput.js'
    includes:
      after_body: '../resources/insert-logo.html'
fontsize: 10pt
params:
  child_path: ''
  setup_path: ../resources/
---



```{r setup, include=FALSE, eval = TRUE}
source(paste0(params$setup_path, "knitr_setup.R"))
with_sol <- TRUE ## in order to control the output
with_course <- TRUE
library('flipbookr')
library(RefManageR)
library(tidyverse)
library(ggplot2)
```

```{r xaringanExtra-share-again, echo=FALSE}
xaringanExtra::use_share_again()
```

```{r reference,  include=FALSE, cache=FALSE, eval = TRUE}
BibOptions(check.entries = FALSE,
           bib.style = "authoryear",
           cite.style = "alphabetic",
           style = "markdown",
           hyperlink = FALSE,
           dashed = FALSE)
myBib <- ReadBib("./lm.bib", check = FALSE)
```

name: intro
# Introduction

---
template: intro
## Un exemple jouet à but pédagogique

On a mesuré la fréquence cardiaque de 20 femmes et 20 hommes.


```{r datapackage, eval = TRUE, echo = FALSE, warning = FALSE}
ggplot <- function(...) ggplot2::ggplot(...) + scale_fill_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) + scale_color_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) 
#remotes::install_github('MarieEtienne/coursesdata', force = TRUE)
```

```{r freqdata, eval = TRUE, echo = c(1,2), warning = FALSE}
library(coursesdata)
data(freqdata)
freqdata %>% ggplot() +  aes(x= Sexe, y = freqC)+  geom_boxplot(aes(fill = Sexe, col = Sexe), alpha = 0.5) + theme(legend.position = 'none')  + 
  geom_jitter( size=0.8, alpha=0.7, width = 0.15, aes(col = as.factor(Sexe)))
```


--
<p class="question"> Les hommes et les femmes ont-ils la même fréquence cardiaque au repos ?</p>

---
template: intro
## Cas d'étude Chauve souris

- Des espèces avec différents régimes alimentaires.
- L'écho localisation (capacité auditive) est un sens essentiel pour les insectivores.

`r Citet(myBib, "hutcheon2002comparative")` ont recensé pour 63 espèces de chauves souris l'espèce, le régime alimentaire, le clade (groupe dans l'arbre phylogénétique), différentes variables morphologiques dont le volume du cerveau dédié à l'audition (AUD)

```{r batsdata, eval = TRUE, echo = FALSE}
data(bats)
bats %>% ggplot() + aes(x= as.factor(Diet), y = AUD) +geom_boxplot(aes(col = as.factor(Diet), fill = as.factor(Diet)), alpha = 0.5) + 
  geom_jitter(size=0.8, alpha=0.7, width = 0.15, aes(col = as.factor(Diet))) + scale_color_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) + scale_fill_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) + theme(legend.position = 'none') + xlab('Diet')
```

--
<p class="question"> Le volume de la partie auditive du cerveau est il lié au régime alimentaire ?</p>

---
template: intro
## Cadre général du modèle d'analyse de la variance à 1 facteur
On étudie le lien entre  
- variable quantitative notée $Y$ (la fréquence cardiaque, volume de cerveau),
- et une variable qualitative (un facteur) pourvant prendre $I$ modalités (I=2 pour l'exemple 1 et I=4 dans l'exemple 2). 


Les données peuvent être visualisées à l'aide d'un boxplot.


--
<p class="question"> La variable d'intérêt Y  est-elle en moyenne différente selon les différentes modalités ?</p>



---
name: model
# Le modèle d'analyse de la variance à 1 facteur

---
template: model

## Graphiquement 

Une visalisation graphique du modèle d'analyse de la variance.

<br> <br> <br> <br>


Comment imagine-t-on le processus aléatoire qui a conduit à nos données ?


---

```{r anova_versiongraphique, eval = TRUE, echo = FALSE}
set.seed(321)
I <- 3
mu <- round(1.5 * rnorm(I),2)
effectif <- runif(n = I, min = 10, max = 30)
fake_dta <- tibble( groupe = rep(1:I, effectif)) %>% group_by(groupe) %>% 
  mutate(y = round(rnorm(n(), mean = mu[groupe], sd = 2),2), mean = mu[groupe] ) %>% mutate(groupe = as.factor(groupe), ord=0)  
norm_dta <- tibble( x  = seq( min(mu) -3*2, max(mu)+ 3* 2, length.out = 100))  %>% 
  mutate(d1 = dnorm(x, mean = mu[1], sd = 2),
         d2 = dnorm(x, mean = mu[2], sd = 2),
         d3 = dnorm(x, mean = mu[3], sd = 2)
  ) %>% 
  pivot_longer(cols = starts_with("d"), names_to = 'Groupe', values_to ='density' )%>% 
  mutate(groupe = as.factor(as.numeric(as.factor(Groupe))))
```

```{r anova_versiongraphique_proba}
ggplot() + 
  xlab('y') +
  ggtitle('Modèle M1') +
  geom_line(data = norm_dta, aes(x= x, y = density, col = groupe)) +
  scale_color_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) +
  theme(legend.position = 'none') + 
  labs(col = 'Groupe') + #BREAK
  geom_vline(data=fake_dta, aes(xintercept = mean, col = groupe), alpha = 0.6) +#BREAK
  geom_point(data = fake_dta, aes(x = y, col = groupe, y=ord), size = 2, alpha = 0.7) 

```

`r chunk_reveal("anova_versiongraphique_proba", break_type = "user", display_type="output")`
---
count:false

```{r anova_versiongraphique_proba2, eval = TRUE, echo = FALSE}
ggplot() +  ggtitle('Modèle M1') +  
  xlab('y') +
  geom_point(data = fake_dta, aes(x = y, col = groupe, y=ord), size = 2, alpha = 0.7)  +
  scale_color_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) +  theme(legend.position = 'none') +
  labs(col = 'Groupe') +
geom_line(data = norm_dta, aes(x= x, y = density, col = groupe), alpha= 0.1) +   
  geom_vline(data=fake_dta, aes(xintercept = mean, col = groupe), alpha = 0.1) #BREAK
```




```{r anova_versiongraphiqueM0, eval = TRUE, echo = FALSE}

mu0 <- mean(fake_dta$y)
fake_dta <- fake_dta %>% mutate(mu0 = mu0)
sd0 <- sd(fake_dta$y)
norm_dta_M0 <- tibble( x  = norm_dta$x)  %>% 
  mutate(d1 = dnorm(x, mean = mu0, sd = sd0),
         d2 = dnorm(x, mean = mu0, sd = sd0),
         d3 = dnorm(x, mean = mu0, sd = sd0)
  ) %>% 
  pivot_longer(cols = starts_with("d"), names_to = 'Groupe', values_to ='density' )%>% 
  mutate(groupe = as.factor(as.numeric(as.factor(Groupe))))
```
---

```{r anova_versiongraphique_proba_M0}
ggplot() + ggtitle('Modèle M0') + 
  xlab('y') +
  geom_line(data = norm_dta_M0, aes(x= x, y = density, col = groupe)) +  
  scale_color_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) +
  theme(legend.position = 'none') + 
  labs(col = 'Groupe') + 
  geom_vline(data=fake_dta, aes(xintercept = mu0, col = groupe), alpha = 0.6) +#BREAK
  geom_point(data = fake_dta, aes(x = y, col = groupe, y=ord), size = 2, alpha = 0.7)

```

`r chunk_reveal("anova_versiongraphique_proba_M0", break_type = "user", display_type="output")`

---
count: false

```{r anova_versiongraphique_proba2_M0, eval = TRUE, echo = FALSE}
ggplot() +  
  xlab('y') +
  ggtitle('Modèle M0')  +  
  geom_point(data = fake_dta_M0, aes(x = y, col = groupe, y=ord), size = 2, alpha = 0.7)  +
  scale_color_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) +  
  theme(legend.position = 'none') + 
  labs(col = 'Groupe') + 
geom_line(data = norm_dta_M0, aes(x= x, y = density, col = groupe), alpha= 0.1) +  #BREAK
  geom_vline(data=fake_dta_M0, aes(xintercept = mu0, col = groupe), alpha = 0.1) #BREAK
```
---
template: model
count: false

```{r anova_versiongraphique_save, eval = TRUE}
p_M1 <- ggplot() + 
  xlab('y') +
  ggtitle('Modèle M1') +
  geom_line(data = norm_dta, aes(x= x, y = density, col = groupe)) +
  scale_color_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) +
  theme(legend.position = 'none') + 
  labs(col = 'Groupe') + #BREAK
  geom_vline(data=fake_dta, aes(xintercept = mean, col = groupe), alpha = 0.6) +#BREAK
  geom_point(data = fake_dta, aes(x = y, col = groupe, y=ord), size = 2, alpha = 0.7) 

p_M0 <-ggplot() +  
  xlab('y') +
  ggtitle('Modèle M0')  +  
  geom_point(data = fake_dta_M0, aes(x = y, col = groupe, y=ord), size = 2, alpha = 0.7)  +
  scale_color_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) +  
  theme(legend.position = 'none') + 
  labs(col = 'Groupe') + 
geom_line(data = norm_dta_M0, aes(x= x, y = density, col = groupe), alpha= 0.1) +  
  geom_vline(data=fake_dta_M0, aes(xintercept = mean, col = groupe), alpha = 0.1) #BREAK
ggpubr::ggarrange(p_M1, p_M0, ncol = 2)
```


<p class="question"> Au vu de nos données, le modèle M1 est-il plus pertinent que le modèle M0 ?</p>



---
template: model

## Version régulière du modèle M1

$$Y_{ik} \overset{ind}{\sim}\mathcal{N}(\mu_i, \sigma^2),$$
avec 
- $i=1,\ldots,I$ le numéro du groupe,
- $k= 1,\ldots, n_i$ le numéro de l'individu dans le groupe $i$, 
- $n_i$ le nombre d'individus dans le groupe $i$ et $n=\sum_i n_i$ le nombre total d'individus,
- $\mu_i$ le comportement moyen du groupe $i$,
- $\sigma^2$ la variance commune à tous les groupes.

### Une écriture équivalente 

$$Y_{ik} = \mu_{i} + E_{ik}, \quad E_{ik}\overset{ind}{\sim}\mathcal{N}(0, \sigma^2).$$


### Nombre de paramètres du modèle

- $I$ paramètres de moyenne  $(\mu_1, \mu_2, \ldots, \mu_I)$; 
- 1 paramètre de variance $\sigma^2$

---
template: model

## Version régulière du modèle M1 sur l'exemple 1

$$Y_{ik} \overset{ind}{\sim}\mathcal{N}(\mu_i, \sigma^2),$$
avec  $I=2$ et  la convention $i=1$ pour les femmes et $i=2$ pour les hommes.

```{r freq_anova, eval= TRUE, echo = TRUE}
freqdata %>%group_by(Sexe) %>% summarise(n= n())
```
Ainsi 
- $k=1, \ldots, n_i$, avec $n_1=20$ et $n_2=20$ et $n=40$.
- $\mu_1$ la fréquence cardiaque moyenne des femmes et $\mu_2$ celle des hommes. 
- $\sigma^2$ la variance commune à tous les groupes.

### Nombre de paramètres
- 2 paramètres de moyenne
- 1 paramètre de variance

---
template: model
## Version singulière du modèle du modèle M1

$$Y_{ik} \overset{ind}{\sim}\mathcal{N}(\mu + \alpha_i, \sigma^2),$$
avec 
- $i=1,\ldots,I$ le numéro du groupe,
- $k= 1,\ldots, n_i$ le numéro de l'individu dans le groupe $i$, ( $\sum_i n_i=n$ )
- $\mu$ un comportement moyen de référence,
- $\alpha_i$ un effet différentiel du groupe $i$par rapport à la référence,
- $\sigma^2$ la variance commune à tous les groupes.

### Une écriture équivalente 

$$Y_{ik} = \mu + \alpha_{i} + E_{ik}, \quad E_{ik}\overset{ind}{\sim}\mathcal{N}(0, \sigma^2).$$

### Nombre de paramètres du modèle

- $I+1$ paramètres de moyenne $(\mu, \alpha_1, \alpha_2, \ldots, \alpha_I)$,
- 1 paramètre de variance $\sigma^2.$

--

#### La version dans les logiciels et celle qui se généralise à plusieurs facteurs.

---
template: model
## Version singulière du modèle du modèle M1 sur l'exemple 1

$$Y_{ik} \overset{ind}{\sim}\mathcal{N}(\mu + \alpha_i, \sigma^2),$$
avec 
- $I=2$ et  la convention $i=1$ pour les femmes et $i=2$ pour les hommes.
- $k=1, \ldots, n_i$, avec $n_1=20$ et $n_2=20$
- $\mu$ la fréquence cardiaque moyenne de référence <a class="care"> Référence à définir </a> 
- $\alpha_1$, l'effet différentiel d'être une femme par rapport à la différence et $\alpha_2$ l'effet différentiel d'être un homme.
- $\sigma^2$ la variance commune à tous les groupes.



### Nombre de paramètres
- 3 paramètres de moyenne
- 1 paramètre de variance


---
template: model
## Lien entre les deux versions du même modèle

 <table style="width:100%">
  <tr>
    <th>Groupe</th>
    <th>V. régulière</th>
    <th>V. singulière</th>
  </tr>
  <tr>
    <td>1</td>
    <td> $\mu_1$ </td>
    <td> $\mu +\alpha_1$ </td>
  </tr>
  <tr>
    <td>2</td>
    <td> $\mu_2$ </td>
    <td> $\mu +\alpha_2$ </td>
  </tr>
    <tr>
    <td> </td>
    <td>  </td>
    <td>   </td>
  </tr>
  </tr>
    <tr>
    <td> </td>
    <td>  </td>
    <td>   </td>
  </tr>
  </tr>
    <tr>
    <td> </td>
    <td>  </td>
    <td>   </td>
  </tr>
    <tr>
    <td>I</td>
    <td> $\mu_I$ </td>
    <td> $\mu +\alpha_I$ </td>
  </tr>
</table> 

--

<a class=care> Problème </a> : Version régulière mal définie. Le modèle dans cette version est dit <a style="font-weight:400;"> indéterminé</a>.


--
####Exemple
Si $\mu_1 =10,\ \mu_2=12,$ dans la forme singulière peut correspondre à 

- $\mu =10,\ \alpha_1=0, \ \alpha_2=2,$
- ou $\mu =0,\ \alpha_1=10, \ \alpha_2=12,$
- ou $\mu =11,\ \alpha_1=-1, \ \alpha_2=1,$
- ou $\mu =15,\ \alpha_1=-5, \ \alpha_2=-3,$
- $\ldots$


--
<a class=care> Solution </a> : Choisir une contrainte. Par défaut dans R, $\alpha_1=0$. La référence est le comportement du groupe 1. 



---
template: model
## Version singulière du modèle du modèle M1 en intégrant la contrainte par défaut



$$Y_{ik} = \mu + \alpha_{i} + E_{ik}, \quad E_{ik}\overset{ind}{\sim}\mathcal{N}(0, \sigma^2).$$

avec 
- $i=1,\ldots,I$ le numéro du groupe,
- $k= 1,\ldots, n_i$ le numéro de l'individu dans le groupe $i$, ($\sum_i n_i = n$ nombre total d'individus)
- $\mu$ un comportement moyen de référence <a class=care> c'est celui du groupe 1</a>
- $\alpha_1=0$  la contrainte choisie, $\alpha_1$ n'est plus un paramètre d'intérêt.
- $\alpha_i, i\geq 2$ un effet différentiel du groupe $i$par rapport à la référence(i.e. le groupe 1)
- $\sigma^2$ la variance commune à tous les groupes.


### Nombre de paramètres du modèle

- $I$ paramètres de moyenne $(\mu,  \alpha_2, \ldots, \alpha_I)$,
- 1 paramètre de variance $\sigma^2.$

---
template: model
## Version singulière du modèle du modèle M1 sur l'exemple 1  en intégrant la contrainte par défaut

$$Y_{ik} \overset{ind}{\sim}\mathcal{N}(\mu + \alpha_i, \sigma^2),$$
avec 
- $I=2$ et  la convention $i=1$ pour les femmes et $i=2$ pour les hommes.
- $k=1, \ldots, n_i$, avec $n_1=20$ et $n_2=20$
- $\mu$ la fréquence cardiaque moyenne des femmesei 
- $\alpha_1$, l'effet différentiel d'être une femme par rapport à la différence et $\alpha_2$ l'effet différentiel d'être un homme.
- $\sigma^2$ la variance commune à tous les groupes.



### Nombre de paramètres
- 3 paramètres de moyenne
- 1 paramètre de variance


---
template: model
## Sous forme matricielle
 $$\bf{Y = X\theta + E}$$
### Forme régulière 

$${\bf{Y}} = \overset{}{\begin{pmatrix}
Y_{11}\\
Y_{12}\\
Y_{13}\\
\vdots\\
Y_{1n_1}\\
Y_{21}\\
Y_{22}\\
\vdots\\
Y_{2n_2}\\
\vdots\\
Y_{In_I}\end{pmatrix}}, \quad
{\bf{X}} =\overset{\color{gray}{\begin{matrix}\mu_1 & \mu_2 & \ldots & \ldots &\mu_I\end{matrix}}}{\begin{pmatrix}
1 & 0 & 0 & \ldots 0\\
1 & 0 & 0 & \ldots 0\\
1 & 0 & 0 & \ldots 0\\
\vdots\\
1 & 0 & 0 & \ldots 0\\
0 & 1 & 0 & \ldots 0 \\
0 & 1 & 0 & \ldots 0 \\\vdots\\
0 & 1 & 0 & \ldots 0 \\\vdots\\
0 & 0 & 0 & \ldots 1 \end{pmatrix}}, \quad
{\bf{\theta}} =\begin{pmatrix}
\mu_{1}\\
\mu_{2}\\
\vdots\\
\mu_I\end{pmatrix}, \quad{\bf{E}} =\begin{pmatrix}
E_{11}\\
E_{12}\\
E_{13}\\
\vdots\\
E_{1n_1}\\
E_{21}\\
E_{22}\\
\vdots\\
E_{2n_2}\\
\vdots\\
E_{In_I}\end{pmatrix}. \quad$$



---
template: model
## Sous forme matricielle
 $$\bf{Y = X\theta + E}$$
### Forme singulière 

$${\bf{Y}} = \overset{}{\begin{pmatrix}
Y_{11}\\
Y_{12}\\
Y_{13}\\
\vdots\\
Y_{1n_1}\\
Y_{21}\\
Y_{22}\\
\vdots\\
Y_{2n_2}\\
\vdots\\
Y_{In_I}\end{pmatrix}}, \quad
{\bf{X}} =\overset{\color{gray}{\begin{matrix}\mu & \alpha_2 & \ldots & \ldots &\alpha_I\end{matrix}}}{\begin{pmatrix}
1 & 0 & 0 & \ldots 0\\
1 & 0 & 0 & \ldots 0\\
1 & 0 & 0 & \ldots 0\\
\vdots\\
1 & 0 & 0 & \ldots 0\\
1 & 1 & 0 & \ldots 0 \\
1 & 1 & 0 & \ldots 0 \\\vdots\\
1 & 1 & 0 & \ldots 0 \\\vdots\\
1 & 0 & 0 & \ldots 1 \end{pmatrix}}, \quad
{\bf{\theta}} =\begin{pmatrix}
\mu\\
\alpha\\
\vdots\\
\alpha_I\end{pmatrix}, \quad{\bf{E}} =\begin{pmatrix}
E_{11}\\
E_{12}\\
E_{13}\\
\vdots\\
E_{1n_1}\\
E_{21}\\
E_{22}\\
\vdots\\
E_{2n_2}\\
\vdots\\
E_{In_I}\end{pmatrix}. \quad$$

---
count: false
template: model
## Déclinaisons sur l'exemple 1 (fréquence cardiaque)

#### Donner les dimensions de $\bf{Y,\ X,\ \theta}$  et $\bf{E}$ (nombre de lignes et de colonnes)

#### Ecrire $\theta$

#### Expliquer comment construire $\bf{X}$


.footnote[
 Pour un rappel sur le produit matriciel : [Wkipedia](https://fr.wikipedia.org/wiki/Produit_matriciel)
]

---
class: inverse
name: pause
# Pause

<br><br><br><br>
<p style="color:#B40F20;font-size:35px;text-align:center;">Prenons une petite pause !!!</p> 

---
name: parametre
# Etude des paramètres du modèle

---
template: parametre
## Quelques précisions de notations et de vocabulaires

- Les données observées (les valeurs prises par la variable $Y$ ) : $\bf{y}=(y_{11}, y_{12}, \ldots, y_{I n_I}).$ 

- En refaisant la même expérience, on obtiendrait d'autres valeurs (liées àaux choix d'individus différents par exemple, ou mesuré un autre jour, ...), on va noter $Y_{ik}$ la variable aléatoire qui décrit la loi des valeurs possibles pour l'individu k du groupe i.   

<br>
<a class=care> les minuscules notent des valeurs, les majuscules des variables aléatoires. </a>
<br>

--

Les paramètres du modèle  sont inconnus. Ils sont notés par des lettres grecques $\bf{\theta}$, $\mu, \alpha, \dots$. 


On veut en donner une estimation à partir des données observées ( $\bf{y}$). Les estimations des paramètres sont notées par les mêmes lettres décorées d'un chapeau $\bf{\hat{\theta}}, \hat{\mu}, \hat{\alpha}, \dots$.  


L'estimateur d'un paramètre est la variable aléatoire correspondante. Il sera noté en majuscule avec une lettre latine. Par exemple, l'etimateur de $\theta$ sera noté $T$, l'estimateur de $\mu$ sera noté $M$ et l'estimateur de $\alpha_1$ sera noté $A_1$.



---
template: parametre
## Estimation des paramètres du modèle version régulière

$$Y_{ik} = \mu_i + E_{ik}, \quad E_{ik}\overset{ind}{\sim}\mathcal{N}(0,\sigma^2).$$

### Estimation

$\mu_i$ représente le comportement moyen de l'ensemble des individus du groupe $i$.  On peut l'estimer par $\hat{\mu}_i = \frac{1}{n_i}\sum_{k=1}^{n_i} y_{ik}$

--

### Estimateur 

L'estimateur de $\mu_i$ est donc défini par $M_i= \frac{1}{n_i}\sum_{k=1}^{n_i} Y_{ik},$  c'est une variable aléatoire

--
- de loi normale (somme de variables normales)

--
- d'espérance $\mathbb{E}(M_i) = \mathbb{E}\left( \frac{1}{n_i}\sum_{k=1}^{n_i} Y_{ik}\right) =  \frac{1}{n_i} \sum_{k=1}^{n_i} \mathbb{E}(Y_{ik}) =\mu_i.$ 
--
<a class=care> C'est un estimateur sans biais</a>
--

- de variance $\mathbb{V}(M_i) = \mathbb{V}\left( \frac{1}{n_i}\sum_{k=1}^{n_i} Y_{ik}\right) =  \frac{1}{n_i^2} \sum_{k=1}^{n_i} \mathbb{V}(Y_{ik}) = \frac{\sigma^2}{n_i}$
--
<a class=care> la variance de l'estimateur diminue quand le nombre de personnes dans le groupe augmente.</a>
--

$$M_i \sim\mathcal{N}\left(\mu_i, \frac{\sigma^2}{n_i}\right).$$


---
template: parametre
## Estimation des paramètres du modèle version singulière avec la contrainte par défaut

$$Y_{ik} = \mu + \alpha_i + E_{ik}, \quad E_{ik}\overset{ind}{\sim}\mathcal{N}(0,\sigma^2).$$

### Estimation

- $\mu$ représente le comportement moyen du groupe 1 (groupe de référence) : $\hat{\mu} = \frac{1}{n_1}\sum_{k=1}^{n_1} y_{1k}$
--

- $\mu + \alpha_i = \mu_i$, donc  $\alpha_i = \mu_i -\mu$ ,représente l'effet différentiel du groupe i par rapport au groupe de référence.  $\hat{\alpha_i} = \frac{1}{n_i}\sum_{k=1}^{n_i} y_{1k} - \hat{\mu}$

--

### Estimateur 

L'estimateur de $\mu$ est donc défini par $M_1= \frac{1}{n_1}\sum_{k=1}^{n_1} Y_{1k}.$  

$$M \sim\mathcal{N}\left(\mu, \frac{\sigma^2}{n_1}\right).$$

--

L'estimateur de $\alpha_i$ est donc défini par $A_i= \frac{1}{n_i}\sum_{k=1}^{n_i} Y_{ik} - \frac{1}{n_1}\sum_{k=1}^{n_1} Y_{1k}.$

$$A_i \sim\mathcal{N}\left(\alpha_i, \sigma^2\left(\frac{1}{n_i} + \frac{1}{n_2}\right) \right).$$


---
template: parametre
## Estimation des paramètres pour l'exemple 1.

### Ce qu'on doit trouver

$$\hat{\mu} =\sum_{k=1}^{n_i} y_{1k}, \quad \hat{\alpha}_2 =\sum_{k=1}^{n_i} y_{2k} - \sum_{k=1}^{n_i} y_{1k}$$

```{r estim_par1,  echo = TRUE, eval = TRUE}
freqdata %>% group_by(Sexe) %>% summarise(m = mean(freqC), n= n())
```
```{r estim_par1_save, eval = TRUE}
resM1 <- freqdata %>% group_by(Sexe) %>% summarise(m = mean(freqC), n= n())
```


--

$\hat{\mu} =$ `r resM1$m[1]` et $\hat{\alpha}_2=$ `r resM1$m[2] - resM1$m[1]`. 


---
count: false
template: parametre
## Estimation des paramètres pour l'exemple 1.

### Ce qu'on doit trouver

$\hat{\mu} =$ `r resM1$m[1]` et $\hat{\alpha}_2=$ `r resM1$m[2] - resM1$m[1]`. 

--


### Estimer avec R

```{r estim_par_lm, echo = TRUE, eval = TRUE}
M1 <- lm(freqC ~ Sexe, data = freqdata)
summary(M1)$coefficients
```

---
count: false
template: parametre
## Estimation des paramètres pour l'exemple 1.

```{r estim_par_lm_2, echo = TRUE, eval = TRUE}
M1 <- lm(freqC ~ Sexe, data = freqdata)
summary(M1)
```

```{r estim_par_lm_3, echo = FALSE, eval = TRUE}
sigma_hat <- summary(M1)$sigma
```

---
template: parametre
## Retour sur la méthode d'estimation - Somme des carrés résiduel (RSS)

Naturellement, on a choisi d'estimer  $\mu_i$ par $\frac{1}{n_1}\sum_{k=1}^{n_1} y_{ik}.$ 

--

En fait, $\hat{\mu}_i$ est choisi pour minimiser $RSS_{obs}$, la somme observée des erreurs au carré  donnée par  

$$RSS_{obs} = \sum_{i=1}^I \sum_{k=1}^{n_i} (y_{ik} - \hat{\mu}_i)^2.$$ 
--

Le modèle d'analyse de la variance 
$$Y_{ik} =\mu_i +E_{ik}.$$
Pour un nouvel individu $k_0$ dans le groupe $i$, le modèle prédit que sa fréquence cardiaque sera $\hat{y}_{ik_0}=\hat{\mu}_i$.

$RSS_{obs}$ se réécrit dans un cadre général comme 

$$RSS_{obs} = \sum_{i=1}^I \sum_{k=1}^{n_i} (y_{ik} - \hat{y}_{ik})^2.$$ 




---
template: parametre

## Loi de RSS

$$\frac{RSS}{\sigma^2} \sim \chi^2(n-I).$$


--

### D'où vient ce $n-I$ ?

La variabilité totale des erreurs est donnée par 

$$\sum_{i=1}^I \sum_{k=1}^{n_i} (y_{ik} - \mu_i)^2= \sum_{i=1}^I \sum_{k=1}^{n_i} (E_{ik})^2,$$
C'est la somme de n variables aléaoires normales centrée de variance $\sigma^2$, donc 

$$\sum_{i=1}^I \sum_{k=1}^{n_i} \left( \frac{E_{ik}}{\sigma}\right)^2 \sim\chi^2(n).$$
--

Mais les $\mu_i$ sont inconnus, on les remplace par leur estimation $\hat{\mu}_i.$

Chaque fois que l'on doit remplacer un paramètre de moyenne par son estimation, on perd un degré de liberté. Ici on a estimé $I$ paramètres de moyenne, d'où le $n-I$.




---
template: parametre
## Le paramètre de variance

Rappel:

Si une variable $U\sim\chi^2(l)$ alors $\mathbb{E}(U)=l$.

Alors $\mathbb{E}\left( \frac{RSS}{\sigma^2} \right) = n-I,$ donc  $\mathbb{E}\left( \frac{RSS}{n-I} \right) = \sigma^2.$

--

## Estimateur de la variance 

La variable aléatoire)  $$S^2 =\frac{1}{n-I} RSS, $$
est un <a class=care> estimateur sans bias de  $\sigma^2$ </a> .

--

## Estimation de $\sigma^2$

$$\hat{\sigma}^2 =\frac{1}{n-I} RSS_{obs}.$$



---
template: parametre
## Estimation du paramètre de variance
 
### Pourquoi diviser par n-I au lieu de n ? 


Le modèle d'analyse de la variance 
$$Y_{ik} =\mu_i +E_{ik}.$$


On aimerait estimer $\sigma$ par  $\frac{1}{n} \sum_{i=1}^I \sum_{k=1}^{n_i} (y_{ik} - \mu_i)^2= \frac{1}{n} \sum_{i=1}^I \sum_{k=1}^{n_i} (E_{ik})^2,$

mais les $\mu_i$ sont inconnus, on les remplace par leur estimation $\hat{\mu}_i.$

Chaque fois que l'on doit remplacer un paramètre de moyenne par son estimation, on perd un degré de liberté. Ici on a estimé $I$ paramètres de moyenne, d'où la nor 



---

```{r var_est}
freqdata %>%  mutate(yhat =  ifelse(Sexe == 'F', 
                                              resM1$m[1], 
                                              resM1$m[2]), 
                               Ehat = freqC-yhat, 
                               Ehat_2 = Ehat^2) %>% #BREAK
  summarise(s=sum(Ehat_2)) %>% simplify() -> RSSobs 
RSSobs #BREAK
sigma2_hat <- RSSobs / (nrow(freqdata) - 2)
sigma2_hat #BREAK
sigma_hat <- sqrt(sigma2_hat)
sigma_hat #BREAK
```



`r chunk_reveal("var_est", break_type = "user")`

---

template: parametre
## Estimation du paramètre de variance sur l'exemple 1

### On doit trouver

$\hat{\sigma}=$ `r sigma_hat`.


--

### Avec R


```{r recal_lm_fit_command, echo = TRUE}
M1 <- lm(freqC ~ Sexe, data = freqdata)
```

--

```{r var_est_lm, echo = TRUE, eval = TRUE}
summary(M1)$sigma
```

---
count: false
template: parametre
## Estimation du paramètre de variance sur l'exemple 1

### On doit trouver

$\hat{\sigma}=$ `r sigma_hat`.



```{r var_est_lm2, echo = TRUE, eval = TRUE}
summary(M1)
```


---
template: parametre
## Visualisation graphique des paramètres estimées

```{r anova_visu_par}
freqdata %>% mutate(ord = 0) %>% ggplot() + xlab('freqC') + ylab('Density') + geom_point(aes(x=freqC, col = Sexe, y = ord), alpha = 0.5) +  scale_color_manual(values = wesanderson::wes_palette(name = "Darjeeling1")) + #BREAK
  geom_vline(data=resM1, aes(xintercept = m, col = Sexe)) + #BREAK
  stat_function(fun = dnorm, n = 101, args = list(mean = resM1$m[1], sd = sigma_hat ), col =  "#FF0000") +
  stat_function(fun = dnorm, n = 101, args = list(mean = resM1$m[2], sd = sigma_hat ), col =  "#00A08A") 
```

---

`r chunk_reveal("anova_visu_par", break_type = "user", display_type="output")`


---
template: parametre
## Estimation des paramètres du modèle version matricielle


Le modèle sous forme matricielle s'écrit

$$\bf{Y = X\theta + E}.$$
--

### Estimation de $\theta$

$$\hat{\theta} = (X^\intercal X )^{-1} X^\intercal Y_{obs}.$$

--

### Estimation de $\theta$

$$\hat{\theta} = (X^\intercal X )^{-1} X^\intercal Y_{obs}.$$
--

### Loi de l'estimation de $\theta$


$$T = (X^\intercal X )^{-1} X^\intercal Y \sim \mathcal{N}_{I}\left(\theta, \sigma^2 (X^\intercal X )^{-1}\right).$$
--

Cette approche très mathématique est utile pour la généralisation, on aura l'occasion d'y revenir !!

---
template: parametre
### Déclinaison sur les exemples

A partir des données de chauve souris, ajuster un modèle  permettant d'expliquer le volume de la partie Auditive (AUD) en fonction du régime.

Il ne s'agit pas de refaire les calculs à la main, mais uniquement d'utiliser la fonction `lm`. 
### Méfiez vous 

- vérifier les degrés de liberté et le nom des paramètres
- Si quelque chose cloche, vérifier la nature de la variable Diet
- On peut transformer une variable en facteur à l'aide de la fonction `as.factor`.


---
template: pause

---
name: modcomp
# Test du modèle complet


---
template: modcomp
## Rappel exemple fréquence cardiaque (exemple 1)

On a mesuré la fréquence cardiaque de 20 femmes et 20 hommes.



```{r freqdata2, ref.label='freqdata', eval = TRUE, warning = FALSE, results ='markup'}
```


--
<p class="question"> Les hommes et les femmes ont-ils la même fréquence cardiaque au repos ?</p>

---
template: modcomp
## Rappel exemple fréquence cardiaque (exemple 1)


<p class="question"> Les hommes et les femmes ont-ils la même fréquence cardiaque au repos ?</p>


Autrement dit


```{r freqdata_graphia_anova, eval = TRUE, warning = FALSE, results ='markup'}
freq_p_M <- ggplot(data = freqdata) + geom_point(aes(x=freqC, y =0, col = Sexe), alpha = 0.5)

freq_p_M1 <- freq_p_M +   stat_function(fun = dnorm, n = 101, args = list(mean = resM1$m[1], sd = sigma_hat ), col =  "#FF0000") +
  stat_function(fun = dnorm, n = 101, args = list(mean = resM1$m[2], sd = sigma_hat ), col =  "#00A08A") +
  geom_vline(aes(xintercept = resM1$m[1] ), col =  "#FF0000") +
  geom_vline(aes(xintercept = resM1$m[2] ), col =  "#00A08A") 
M0 <- lm(freqC~1, data = freqdata)
freq_p_M0 <- freq_p_M +   stat_function(fun = dnorm, n = 101, args = list(mean = coef(M0), sd = summary(M0)$sigma ), col =  "#FF0000") +
 stat_function(fun = dnorm, n = 101, args = list(mean = coef(M0), sd = summary(M0)$sigma ),  col =  "#00A08A") +
  geom_vline(aes(xintercept =  coef(M0)), col= "#FF0000") +
  geom_vline(aes(xintercept =  coef(M0) ), col =  "#00A08A")  + theme(legend.position =  'bottom' )
ggpubr::ggarrange(freq_p_M1, freq_p_M0, common.legend = TRUE)
```


---
template: modcomp
## Test de l'existence d'un effet


<p class="question"> Le comportement moyen de la variable $Y$ est il différent selon les différentes modalités de la variable explicative ?</p>

--

Deux modèles possibles
$$M1 : Y_{ik} = \mu =\alpha_i + E_{ik},\quad  M0: Y_{ik} = \mu  + E_{ik}$$

<p class="question"> Le modèle M1 est il plus pertinent que le modèle M0?</p>


---
template: modcomp
## Mesurer la partie de variabilité expliquée par le modèle

--

### Variabilité totale dans les données

$$RSS_{0, obs} = \sum_{i=1}^{I} \sum_{k=1}^{n_i} (y_{ik} - \bar{y})^2.$$ 
--

### Variabilité résiduelle dans le modèle M1

$$RSS_{1, obs} = \sum_{i=1}^{I} \sum_{k=1}^{n_i} (y_{ik} - \hat{y}_{ik})^2.$$ 
--

### Variabilité expliquée par le modèle M1

$$SS_{M1,obs} =  RSS_{0, obs} - RSS_{1, obs}.$$ 
C'est la quantité de variabilité expliquée par les différence entre les I populations.

--

<p class=care> Si la variabilité expliquée par le modèle $M1$ est grande, on gagne à considérer des ppopulations différentes <p>

On a mis en évidence des différences entre les populations.


---
## Calcul de RSS sur l'exemple 1
 A la main :

```{r rss_cache, ref.label=rss, eval = TRUE}
```



```{r rss}
freqdata %>% group_by(Sexe) %>% 
  mutate(m= mean(freqC)) %>% 
  mutate( Ehat = freqC - m) %>% 
  mutate( E2hat = Ehat^2) %>% 
  ungroup() %>% 
  summarise(RSSM1 =sum(E2hat)) -> 
  RSSM1
freqdata %>%  mutate(m= mean(freqC)) %>% 
  mutate( Ehat = freqC - m) %>% 
  mutate( E2hat = Ehat^2) %>% 
  summarise(RSSM1 =sum(E2hat)) -> 
  RSSM0
SSM <- RSSM0 - RSSM1
SSM
```

--- 

`r chunk_reveal("rss", break_type = "auto")`


```{r rss_cache,  eval = TRUE}
freqdata %>% group_by(Sexe) %>% 
  mutate(m= mean(freqC)) %>% 
  mutate( Ehat = freqC - m) %>% 
  mutate( E2hat = Ehat^2) %>% 
  ungroup() %>% 
  summarise(RSSM1 =sum(E2hat)) -> 
  RSSM1
freqdata %>%  mutate(m= mean(freqC)) %>% 
  mutate( Ehat = freqC - m) %>% 
  mutate( E2hat = Ehat^2) %>% 
  summarise(RSSM1 =sum(E2hat)) -> 
  RSSM0
SSM <- RSSM0 - RSSM1
SSM
```

---
## Calcul de RSS sur l'exemple 1


```{r SCM,  echo = TRUE, eval = TRUE, highlight = 1:2}
M1 <- lm(freqC ~ Sexe, data= freqdata)
M0 <- lm(freqC ~ 1, data= freqdata)
anova(M0, M1)
```



---
template: modcomp
## Quand décider si $SS_{M1, obs}$ est grande ?  


--
C'est le rôle du test statistique.

--

Idée de démarche:

- Décrire quelle gamme de valeurs pourrait prendre SSM dans le cas où il n'y pas de différence entre les population 
- Comparer avec ce qu'on constate sur nos données
- 
    - Si c'est comparable, pas de raison de penser qu'il y a des population différentes,
    - Si c'est surprenant, les populations sont vraisemblablement différentes.

--

On veut décrire comment varie $SS_{M1, obs}$ dans la situation où il n"y a pas de différence entre les groupes.

On travaille donc sous l'hypothèse 
$$H_0 =\left \lbrace \mbox{Pas de différence entre les groupes }\right\rbrace$$

--

$$H_0 =\left \lbrace  \mbox{pour tout }i, \alpha_i =0  \right\rbrace$$

--

$$H_0 =\left \lbrace  M1 \mbox{ est équivalent à } M0 \right\rbrace.$$

---
template: modcomp
## Hypothèses du test

On va donc opposer une hypothèse de travail $H_0$ contre une hypothèse alternative $H_1$. $H_0$ peut donc prendre différentes formes:


$$\begin{align} 
H_0 & =\left \lbrace \mbox{Pas de différence entre les groupes }\right\rbrace\\
    & =\left \lbrace  \mbox{pour tout }i, \alpha_i =0  \right\rbrace\\
    & =\left \lbrace  M1 \mbox{ est équivalent à } M0 \right\rbrace.
\end{align}$$

$H_1$ prend les formes équivalentes suivantes

$$\begin{align} 
H_1 & =\left \lbrace \mbox{Au moins 1 groupe est différent des autres}\right\rbrace\\
    & =\left \lbrace  \mbox{Il existe un }i, \alpha_i  \ne 0  \right\rbrace\\
    & =\left \lbrace  M1 \mbox{ est préférable à } M0 \right\rbrace.
\end{align}$$
---
## Loi de la statistique de test sous H0


Il faut être capable de décrire quelles sont les valeurs possibles de $SS_{M1, obs}$, pour ceci il faut connaitre la loi de la variable aléatoire $SS_{M1}$.

-
On peut montrer que sous $H_0$,  

$$\frac{SS_{M1}}{\sigma^2} \underset{H_0}{\sim}\chi^2(I-1)$$  

--
Mais $\sigma^2$ est inconnu, on a envie de le remplacer par son estimateur $RSS / (n-I).$

--


<p class=question> 
Sous $H_0$, 
$$F= \frac{\frac{SS_{M1}}{I-1}}{\frac{RSS}{n-I}} \underset{H_0}{\sim}\mathcal{F}(I-1, n-I)$$  
</p>




---
template: modcomp
## Loi de la statistique de test sous H0 - graphiquement

Sous $H0$ la loi de distribution de $F$ est 

```{r , eval = TRUE}
tibble(x = seq(0, 3, length.out = 501)) %>% 
  mutate(y = df(x, df1 = 4, df= 38)) -> chi_dta
```

--- 

Si on a observé $Fobs$, comment savaoir si--


## Déclinaison sur les exemples

---
template: pause

---

# Test sur un paramètre

## Réflexion sur le sens de ce test

## loi de la statistique de test

## Déclinaison sur les exemples

---
# Vérification graphique des hypothèses de modélisation


---
# Démarche complète d'analyse à partir de l'exemple des chauves souris



---
template: pause

Avant de passer à l'analyse de variance à deux facteurs
---



